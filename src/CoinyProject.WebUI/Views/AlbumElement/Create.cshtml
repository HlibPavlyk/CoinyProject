@using CoinyProject.Application.DTO
@model AlbumElementCreating
<form id="form" method="post" enctype="multipart/form-data">
    <div class="border p-3 mt-4">
        <div class="row pb-2">
            <h2 class="text-primary">Create Album Element</h2>
            <hr />
        <div class="row">
            <div class="col-md-8">
                
                <div class="mb-3 row p-1">
                    <label asp-for="Name" class="p-0"></label>
                    <input asp-for="Name" class="form-control" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>
                <div class="mb-3 row p-1">
                    <label asp-for="Description" class="p-0"></label>
                    <input asp-for="Description" class="form-control" />
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>
                <div class="mb-3 row p-1">
                    <label asp-for="Image" class="p-0"></label>
                    <input id="imgFile" asp-for="Image" type="file" class="form-control" />
                        <span asp-validation-for="Image" class="text-danger"></span>
                </div>
            </div>
                <div class="col-md-4 ">
                    <img id="imgViewer" width="300" height="300" class="rounded mx-auto d-block border-3" />
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-3">
                <button id="btnSave" type="submit" class="btn btn-primary form-control">Add Album Element</button>
            </div>
            <div class="col-6 col-md-3">
                <a asp-controller="AlbumElement" asp-action="Commit" class="btn btn-outline-secondary form-control text-primary">
                    Create Album
                </a>
            </div>
        </div>
        </div>
    </div>
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">

<script type="text/javascript">
    window.addEventListener('DOMContentLoaded', () => {
        const imgFile = document.getElementById('imgFile');
        const imgViewer = document.getElementById('imgViewer');
        const btnSave = document.getElementById('btnSave');
        const form = document.getElementById('form');

        let cropper; // Змінна для екземпляру Cropper.js

        // При зміні файлу
        imgFile.onchange = evt => {
            const [file] = imgFile.files;
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imgViewer.src = e.target.result;
                    if (cropper) {
                        cropper.destroy(); // Видаляємо попередній Cropper.js, якщо він існує
                    }
                    cropper = new Cropper(imgViewer, {
                        aspectRatio: 1, // Задаємо співвідношення сторін для обрізки, наприклад, 1:1
                        viewMode: 1, // Фіксуємо область обрізки
                        crop(event) {
                            // Виводимо в консоль координати та розміри області обрізки
                            console.log(event.detail.x);
                            console.log(event.detail.y);
                            console.log(event.detail.width);
                            console.log(event.detail.height);
                        },
                    });
                };
                reader.readAsDataURL(file);
            }
        };

        // При натисканні на кнопку "Add Album Element"
        btnSave.onclick = () => {
            if (cropper) {
                // Отримуємо обрізане фото у форматі Blob
                cropper.getCroppedCanvas().toBlob((blob) => {
                    // Створюємо FormData об'єкт для передачі на сервер
                    console.log(form);
                    const formData = new FormData(imgFile);
                    console.log(formData);
                    formData.append('croppedImage', blob, 'croppedImage.jpg');
                    console.log(formData);
                    // Відправляємо дані на сервер за допомогою fetch або іншого методу
                    fetch('/AlbumElement/Create', {
                        method: 'POST',
                        body: formData, // Use 'body' instead of 'data'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            console.log('Image uploaded successfully');
                            // Handle the response if needed
                        })
                        .catch(error => {
                            console.error('Error uploading image:', error);
                        });
                });
            }
        };
    });
</script>

@section Scripts {
    @{
        <partial name="_ValidationScriptsPartial" />
    }
}
